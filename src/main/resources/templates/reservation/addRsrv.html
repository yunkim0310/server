<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Reservation Form</title>
    <script src="https://js.tosspayments.com/v1"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script>

        /*function generateTimeArray(openTime, closeTime, breakStart, breakEnd) {
            const start = parseTime(openTime);
            const end = parseTime(closeTime);
            const breakStartTime = parseTime(breakStart);
            const breakEndTime = parseTime(breakEnd);
            const result = [];

            while (start < end) {
                // Check if the current time is within the break time range
                if (start < breakStartTime || start >= breakEndTime) {
                    result.push(formatTime(start));
                }
                // Add 30 minutes
                start.setMinutes(start.getMinutes() + 30);
            }

            return result;
        }*/
        function generateTimeArray(openTime, closeTime, breakStart, breakEnd, reservationTimeStatusList, maxLimit) {
            const start = parseTime(openTime);
            const end = parseTime(closeTime);
            const breakStartTime = parseTime(breakStart);
            const breakEndTime = parseTime(breakEnd);
            const result = [];

            // console.log(reservationTimeStatusList, maxLimit);

            while (start < end) {
                // 현재 시간 포맷
                const currentTime = formatTime(start);

                // 예약 시간인지 확인
                const isReservedOverLimit = reservationTimeStatusList.some(reservation => {
                    const reservationTime = formatTime(parseTime(reservation.rsrvDt.split(' ')[1]));
                    // console.log('reservationTime', reservationTime, reservation.rsrvPerson, maxLimit);
                    return reservationTime === currentTime && reservation.rsrvPerson > maxLimit;
                });

                // Check if the current time is within the break time range and reservation limit
                if ((start < breakStartTime || start >= breakEndTime) && !isReservedOverLimit) {
                    result.push(currentTime);
                }
                // Add 30 minutes
                start.setMinutes(start.getMinutes() + 30);
            }

            return result;
        }

        // Helper function to parse time strings (e.g., "10:00") into Date objects
        function parseTime(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        // Helper function to format Date objects into time strings (e.g., "10:00")
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function generateTimeTable(timeArray) {
            const timeTable = document.getElementById('time-table');
            timeTable.innerHTML = ''; // Clear existing content
            const maxPerRow = 5; // Maximum buttons per row
            let currentRow;

            timeArray.forEach((time, index) => {
                if (index % maxPerRow === 0) {
                    // Create a new row every 5 buttons
                    currentRow = document.createElement('div');
                    currentRow.className = 'time-row';
                    timeTable.appendChild(currentRow);
                }
                // Create a button for the time slot
                const button = document.createElement('button');
                button.className = 'time';
                button.textContent = time;
                button.setAttribute('onclick', 'selectTime(this)');
                currentRow.appendChild(button);
            });

            // Make the time table visible (if initially hidden)
            timeTable.classList.remove('no-display');
        }


        // JavaScript로 날짜 제한 및 이벤트 설정
        document.addEventListener("DOMContentLoaded", function () {
            const rsrvDt = document.getElementById("rsrvDt");
            const operationDetails = document.getElementById("operationDetails");

            // 현재 날짜와 시간
            const now = new Date();
            const nowISO = now.toISOString().slice(0, 16);

            // 13일 후 날짜 계산
            const futureDate = new Date();
            futureDate.setDate(now.getDate() + 13);
            const futureISO = futureDate.toISOString().slice(0, 16);

            // min 및 max 속성 설정
            rsrvDt.min = nowISO;
            rsrvDt.max = futureISO;

            // 날짜 변경 시 서버에서 운영 정보 가져오기
            rsrvDt.addEventListener("change", function () {
                const selectedDate = rsrvDt.value; // yyyy-MM-ddTHH:mm 형식

                if (selectedDate) {
                    // Ajax 요청으로 운영 정보 가져오기
                    fetch(`/api-reservation/getOperationByDate?storeId=${document.querySelector('[name="storeId"]').value}&effectDt=${selectedDate.split("T")[0]}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data) {
                                // 운영 정보 출력
                                operationDetails.innerHTML = `
                                    <h3>Store Operation Details</h3>
                                    <p>Open Time: ${data.storeOperation.openTime || "N/A"}</p>
                                    <p>Close Time: ${data.storeOperation.closeTime || "N/A"}</p>
                                    <p>Break Time Start: ${data.storeOperation.breakTimeStart || "N/A"}</p>
                                    <p>Break Time End: ${data.storeOperation.breakTimeEnd || "N/A"}</p>
                                    <p>Max Reservation Limit: ${data.storeOperation.rsrvLimit || "N/A"}</p>
                                `;


                                // Example Usage
                                const openTime = data.storeOperation.openTime;
                                const closeTime = data.storeOperation.closeTime;
                                const breakStart = data.storeOperation.breakTimeStart;
                                const breakEnd = data.storeOperation.breakTimeEnd;

                                const timeArray = generateTimeArray(openTime, closeTime, breakStart, breakEnd, data.reservationTimeStatusList, data.storeOperation.rsrvLimit);
                                console.log(timeArray);

                                generateTimeTable(timeArray);

                            } else {
                                operationDetails.innerHTML = `<p>No operation details found for the selected date.</p>`;
                            }
                        })
                        .catch(error => {
                            console.error("Error fetching operation details:", error);
                            operationDetails.innerHTML = `<p>Error fetching operation details. Please try again later.</p>`;
                        });
                } else {
                    operationDetails.innerHTML = `<p>Please select a valid date.</p>`;
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var today = new Date();
            today.setHours(0, 0, 0, 0); // 오늘 자정 기준
            var endDate = new Date(today);
            endDate.setDate(today.getDate() + 14); // 14일 후

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: "ko",
                selectable: true,
                // 비활성화할 날짜에 클래스 추가
                dayCellClassNames: function(arg) {
                    var cellDate = arg.date;
                    if (cellDate < today || cellDate >= endDate) {
                        return ['fc-disabled'];
                    }
                    return [];
                },
                // 비활성화된 날짜는 선택 방지
                dateClick: function(info) {
                    if (info.date >= today && info.date < endDate) {
                        document.querySelectorAll('.fc-daygrid-day.fc-selected').forEach(function(day) {
                            day.classList.remove('fc-selected');
                        });
                        info.dayEl.classList.add('fc-selected');
                    }

                    document.getElementById('time-table').classList.remove('no-display');

                    selectedDate = info.dateStr;
                    console.log(selectedDate);
                }
            });
            calendar.render();
        });
    </script>
    <style>
        .time-table { margin-top: 10px; width: 100%;}
    </style>
</head>
<body>
<h1>Make a Reservation</h1>

<div id='calendar' style="width: 600px;"></div>


<div id='time-table' class="time-table no-display">
<!--    <div class="time-row">-->
<!--        <button class="time" onclick="selectTime(this)">12:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">13:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">14:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">15:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">16:00</button>-->
<!--    </div>-->
<!--    <div class="time-row">-->
<!--        <button class="time" onclick="selectTime(this)">12:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">13:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">14:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">15:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">16:00</button>-->
<!--    </div>-->
<!--    <div class="time-row">-->
<!--        <button class="time" onclick="selectTime(this)">12:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">13:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">14:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">15:00</button>-->
<!--        <button class="time" onclick="selectTime(this)">16:00</button>-->
<!--    </div>-->
</div>



<!-- 가게 정보 -->
<h2>Store Information</h2>
<p>Store Name: <span th:text="${store.storeName}">[Store Name]</span></p>
<p>Store Address: <span th:text="${store.storeAddr}">[Store Address]</span></p>

<!-- 예약 입력 폼 -->
<h2>Reservation Details</h2>
<form action="/reservation/addRsrv" method="post">
    <!-- 가게 ID 전달 -->
    <input type="hidden" name="storeId" th:value="${store.storeId}" />
    <input type="hidden" name="storeName" th:value="${store.storeName}" />
    <input type="hidden" name="storeAddr" th:value="${store.storeAddr}" />

    <label for="userName">Your Name:</label>
    <input type="text" id="userName" name="userName" required /><br><br>

    <label for="rsrvPerson">Number of People:</label>
    <input type="number" id="rsrvPerson" name="rsrvPerson" min="1" required /><br><br>

    <label for="amount">Amount:</label>
    <input type="number" id="amount" name="amount" min="5000" required /><br><br>

    <label for="rsrvDt">Reservation Date & Time:</label>
    <input type="datetime-local" id="rsrvDt" name="rsrvDt" required /><br><br>

    <label for="rsrvReq">Request:</label>
    <input type="text" id="rsrvReq" name="rsrvReq" required /><br><br>

    <label for="rsrvNumber">Phone Number:</label>
    <input type="tel" id="rsrvNumber" name="rsrvNumber" required pattern="[0-9]{10,11}" placeholder="01012345678" /><br><br>

    <button type="submit" id="payButton">Submit Reservation</button>

</form>

<!-- 운영 정보 표시 -->
<div id="operationDetails">
    <h3>Store Operation Details</h3>
    <p>Select a date to see operation details.</p>
</div>


</body>
</html>
