<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>일반 회원 예약 목록</title>
    <link th:insert="~{common/import :: importFragment}">
    <link rel="stylesheet" href="/css/templates/style.css">
    <link rel="stylesheet" href="/css/templates/regist_hp.css">
    <script type="module" src="/javascript/store/searchStore.js"></script>

    <style>
      .container {
        margin: 0 auto;
        width: 1400px;
        display: flex; /* Flexbox 사용 */
        justify-content: center; /* 가로 방향 가운데 정렬 */
        align-items: center; /* 세로 방향 가운데 정렬 (필요하면 추가) */
        height: 100vh; /* 전체 높이 설정 */
      }

      .pl {
        display: flex; /* Flexbox 사용 */
        flex-direction: column; /* 세로 정렬 */
        gap: 10px; /* 요소 간의 간격 */
        width: 200px; /* 적절한 너비 설정 */
        height: 150px;
      }

      .pl select {
        background-color: #4880FF; /* 배경색을 파란색으로 설정 */
        color: white; /* 글자 색상을 하얀색으로 설정 */
        font-size: 24px; /* 글자 크기 설정 (원하는 크기로 조정 가능) */
        font-weight: bold; /* 글자 굵기 설정 (옵션) */
        text-align: center; /* 텍스트 중앙 정렬 */
        padding: 10px; /* 안쪽 여백 설정 */
        height: 80px; /* 셀렉트 박스 높이 조정 */
        border: none; /* 테두리 제거 */
        border-radius: 5px; /* 둥근 테두리 설정 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 그림자 추가 (옵션) */
        cursor: pointer; /* 마우스 오버 시 커서 변경 */
      }

      .pl option {
        background-color: white; /* 드롭다운 옵션 배경색 설정 */
        color: black; /* 옵션 텍스트 색상 */
        font-size: 16px; /* 옵션 글씨 크기 */
        padding: 5px; /* 옵션 내부 여백 */
      }

      .reservation-list {
        display: flex;
        flex-direction: column; /* 내부 요소를 세로로 정렬 */
        gap: 20px; /* 내부 요소 간 간격 */
        width: 550px; /* 예약 리스트의 너비 */
        max-width: 100%; /* 최대 너비를 설정 */
        padding: 15px; /* 내부 여백 */
        height: 80vh; /* 리스트 높이 제한 */
        margin-left: 20px; /* 왼쪽 여백 추가로 오른쪽으로 이동 */
      }


      .reservation-item {
        border: 1px solid #4880FF;
        border-radius: 10px;
        padding: 20px;
        background-color: #F8F8F8;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 500px;
        max-width: 100%;
      }

      .reservation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .reservation-header .reservation-date {
        font-size: 30px;
        font-weight: bold;
        color: #333;
      }

      .reservation-header .reservation-number {
        font-size: 16px;
        color: #888;
        text-align: right;
      }

      .reservation-body {
        display: flex;
        justify-content: flex-start; /* 텍스트와 이미지를 나란히 배치 */
        align-items: flex-start; /* 상단 정렬 */
      }

      .reservation-details {
        flex: 1; /* 텍스트 부분이 충분한 공간을 차지하도록 설정 */
      }

      .reservation-body p {
        margin: 10px 0;
        font-size: 18px;
        color: #333;
        flex: 1; /* 텍스트가 공간을 충분히 차지하도록 설정 */
      }

      .reservation-body img {
        margin-left: 20px; /* 텍스트와 이미지 간 간격 */
        height: 180px;
        width: 150px;
        align-self: flex-start; /* 이미지가 텍스트의 상단에 맞춰 정렬되도록 설정 */
      }

      .reservation-status {
        display: flex;
        justify-content: space-between; /* 좌우로 정렬 */
        align-items: center; /* 세로 정렬 */
        margin: 10px 0;
        font-size: 16px;
        font-weight: bold;
        color: #333;
      }


      .review-button {
        background-color: #4880FF;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        display: block;
      }

      .review-button:hover {
        background-color: #E04E4E;
      }

      .status-actions {
        display: flex;
        align-items: center;
        min-height: 40px; /* 버튼이 없어도 일정한 공간 유지 */
      }

      form#searchForm {
        position: fixed;
        top: 300px; /* 상단에서 20px 위치 */
        right: 200px; /* 오른쪽에서 20px 위치 */
        display: flex; /* 내부 요소 정렬을 위한 flexbox 설정 */
        flex-direction: column; /* 내부 요소를 세로로 정렬 */
        gap: 10px; /* 내부 요소 간 간격 */
        padding: 15px; /* 폼 내부 여백 */
        border-radius: 10px; /* 테두리 둥글게 설정 */
      }

    </style>


    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const reservationItems = document.querySelectorAll(".reservation-item");
        const reservationListCount = document.querySelectorAll(".reservation-item").length;

        // <div> 요소 가져오기
        const pagingContainer = document.querySelector(".paging-container");

        reservationItems.forEach(item => {
          item.addEventListener("click", function (event) {

            const reservationNumber = this.querySelector(".reservation-number").textContent.trim();
            // 리뷰 작성 버튼 클릭 시 네비게이션 제외
            if (event.target.classList.contains("review-button")) {

              const review = `/review/addReview`; // 이동할 링크
              return window.location.href = review; // 해당 링크로 네비게이션
            }

            // 예약 번호 가져오기
            const destination = `/reservation/getRsrv?rsrvNo=${reservationNumber}`; // 이동할 링크
            window.location.href = destination; // 해당 링크로 네비게이션
          });
        });

        if (pagingContainer) {
          // 기본 <br> 개수 설정 (5개)
          let brCount = 1;

          // 예약 리스트가 있을 경우, 리스트 개수 * 5
          if (reservationListCount > 0) {
            brCount = reservationListCount * 14;
          }

          // <br> 태그 추가
          for (let i = 0; i < brCount; i++) {
            const br = document.createElement("br");
            pagingContainer.insertAdjacentElement("beforebegin", br); // <div> 바로 위에 삽입
          }
        }


      });

      document.addEventListener("DOMContentLoaded", function () {
        const phoneElements = document.querySelectorAll("[data-phone]");

        phoneElements.forEach(element => {
          const originalNumber = element.textContent.trim(); // 원래 전화번호 가져오기
          if (originalNumber.length >= 7) {
            const maskedNumber = originalNumber.substring(0, 3) + "xxxx" + originalNumber.substring(7);
            element.textContent = maskedNumber; // 마스킹된 번호로 교체
          }
        });
      });


      function search(page) {

        $("input[name='page']").val(page);
        $("form[name='searchForm']").attr("action", "/reservation/getRsrvUserList").attr("method", "post").submit();
      }
      function autoSubmitForm() {
        document.getElementById("searchForm").submit();
      }

      pageNavigator(search);


    </script>

  </head>
  <body>

    <h1 style="font-size: 27px; font-family: Arial, Helvetica, sans-serif; font-weight: bold; color: black; margin-top: 25px;" ><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;예약 목록</h1>

    <div class="container">
      <!-- 예약 리스트 -->
      <div class="reservation-list">
        <table>
          <tbody>
            <div class="reservation-item" th:each="reservation : ${reservations}" style="cursor: pointer;">
              <div class="reservation-header">
                <span class="reservation-date" th:text="${#dates.format(reservation.rsrvDt, 'yyyy.MM.dd')}"/>
              </div>
                <!-- 본문 -->
              <div class="reservation-body">
                <div class="reservation-details">
                  <br/>
                  <br/>
                  <p><strong>예약 시간&nbsp;&nbsp;&nbsp;</strong> <span th:text="${#dates.format(reservation.rsrvDt, 'HH:mm')}"/></p>
                  <p><strong>매 &nbsp;장&nbsp; 명&nbsp;&nbsp;&nbsp;</strong> <span th:text="${reservation.storeName}"/></p>
                  <p><strong>전화 번호&nbsp;&nbsp;&nbsp;&nbsp;</strong> <span th:text="${reservation.rsrvNumber}" data-phone/></p>
                  <p><strong>예약 인수&nbsp;&nbsp;&nbsp;&nbsp;</strong> <span th:text="${reservation.rsrvPerson}"/>명</p>
                  <p><strong>예약 번호&nbsp;&nbsp;&nbsp;&nbsp;</strong> <span class="reservation-number" th:text="${reservation.rsrvNo}"/></p>
                </div>
                <div>
                  <img class="img"
                       th:src="${(reservation.store.storeImg1.indexOf('_') != -1)? '/images/store/store/'+reservation.store.storeImg1 : url + reservation.store.storeImg1}"/>
                </div>
              </div>
                <!-- 상태 -->
              <div class="reservation-status">
                <span th:text="${reservation.rsrvStatus}"/>
                <!-- 리뷰 작성 버튼 -->
                <div class="status-actions">
                  <button class="review-button" th:if="${reservation.rsrvStatus == '이용 완료'}" th:text="'리뷰 작성'"></button>
                </div>
              </div>
            </div>
          </tbody>
        </table>
      </div>

      <!-- 검색 폼 -->
      <form id="searchForm" name="searchForm">
        <!-- 예약 상태 -->
        <!-- 유저 이름 (필수) -->
        <input type="hidden" name="userName" th:value="${param.userName}" />
        <div class="pl">
          <select id="searchKeyword" name="searchKeyword" onchange="autoSubmitForm()">
            <option value="" th:selected="${search.searchKeyword == null || search.searchKeyword == ''}">모든 상태</option>
            <option value="예약 요청" th:selected="${search.searchKeyword =='예약 요청'? 'selected' : null}">예약 요청</option>
            <option value="예약 확정" th:selected="${search.searchKeyword =='예약 확정'? 'selected' : null}">예약 확정</option>
            <option value="이용 완료" th:selected="${search.searchKeyword =='이용 완료'? 'selected' : null}">이용 완료</option>
            <option value="리뷰 완료" th:selected="${search.searchKeyword =='리뷰 완료'? 'selected' : null}">리뷰 완료</option>
            <option value="예약 취소" th:selected="${search.searchKeyword =='예약 취소'? 'selected' : null}">예약 취소</option>
            <option value="예약 거절" th:selected="${search.searchKeyword =='예약 거절'? 'selected' : null}">예약 거절</option>
          </select>

          <!-- 정렬 방식 -->
          <select id="order" name="order" onchange="autoSubmitForm()">
            <option value="desc" th:selected="${search.order == 'desc'? 'selected' : null}">내림차순</option>
            <option value="asc" th:selected="${search.order == 'asc'? 'selected' : null}">오름차순</option>
          </select>
        </div>


        <input type="hidden" name="page" th:value="1">

      </form>


    </div>
    <div class="paging-container">
    <th:block th:insert="~{common/paging :: pagingFragment}"></th:block>
    </div>
  </body>
</html>