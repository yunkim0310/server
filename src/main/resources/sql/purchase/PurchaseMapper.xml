<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.placeHere.server.dao.pointShop.PurchaseDao">

    <!-- resultMap -->
    <resultMap id="purchaseSelectMap" type="com.placeHere.server.domain.Purchase">
        <result property="tranNo" column="tran_no" jdbcType="INTEGER"/>
        <result property="userName" column="username" jdbcType="VARCHAR"/>
        <result property="prodNo" column="prod_no" jdbcType="INTEGER"/>
        <result property="relNo" column="rel_no" jdbcType="INTEGER"/>
        <result property="barcodeNo" column="barcode_no" jdbcType="VARCHAR"/>
        <result property="barcodeImg" column="barcode_img" jdbcType="VARCHAR"/>
        <result property="cntProd" column="cnt_prod" jdbcType="INTEGER"/>
        <result property="tranPoint" column="tran_point" jdbcType="INTEGER"/>
        <result property="pointDt" column="point_dt" jdbcType="DATE"/>
        <result property="depType" column="dep_type" jdbcType="VARCHAR"/>
        <result property="currPoint" column="curr_point" jdbcType="INTEGER"/>
        <result property="wishCartNo" column="wishcart_no" jdbcType="INTEGER"/>
    </resultMap>

    <insert id="addPurchase" parameterType="com.placeHere.server.domain.Purchase">
        INSERT INTO Point_Transaction (
            username, prod_no, barcode_no, barcode_img, cnt_prod, tran_point, point_dt, curr_point
        )
        VALUES (
                   #{userName}, #{prodNo}, #{barcodeNo}, #{barcodeName}, #{cntProd}, #{tranPoint}, CURRENT_DATE, #{currPoint}
               )
    </insert>


    <select id="calcTranPoint" parameterType="String" resultType="int">
        SELECT SUM(p.prod_price * pt.cnt_prod)
        FROM Point_Transaction pt
        JOIN Product p ON pt.prod_no = p.prod_no
        WHERE pt.username = #{userName}
        AND pt.point_dt = CURRENT_DATE
    </select>

    <select id="getPurchase" parameterType="int" resultMap="purchaseSelectMap">
        SELECT
        pt.tran_no, pt.username, pt.prod_no, pt.rel_no, pt.barcode_no, pt.barcode_img,
        pt.cnt_prod, pt.tran_point, pt.point_dt, pt.dep_type, pt.curr_point,
        p.prod_name, p.prod_detail, p.prod_price, p.prod_img1, p.prod_img2, p.prod_img3
        FROM Point_Transaction pt
        JOIN Product p ON pt.prod_no = p.prod_no
        WHERE pt.tran_no = #{tranNo} AND pt.username = #{userName}
    </select>

    <select id="getPurchaseList" parameterType="String" resultMap="purchaseSelectMap">
        SELECT
        pt.tran_no, pt.username, pt.prod_no,
        p.prod_name, p.prod_price, p.prod_img1
        FROM Point_Transaction pt
        JOIN Product p ON pt.prod_no = p.prod_no
        WHERE pt.username = #{userName}
        ORDER BY pt.tran_no DESC
    </select>

<!--    <select id="getNextBarcodeNumber" resultType="String">-->
<!--        SELECT LAST_INSERT_ID()-->
<!--    </select>-->

<!--    <select id="getNextBarcodeNumber" resultType="String">-->
<!--        SELECT UUID_SHORT()-->
<!--    </select>-->

    <!-- 장바구니에 상품 추가 -->
    <insert id="addCart" parameterType="com.placeHere.server.domain.Purchase">
        INSERT INTO WishCart (username, prod_no, cnt_prod)
        VALUES (#{userName}, #{prodNo}, #{cntProd})
    </insert>

    <!-- 찜 목록에 상품 추가 -->
    <insert id="addWish" parameterType="com.placeHere.server.domain.Purchase">
        INSERT INTO WishCart (username, prod_no, cnt_prod)
        VALUES (#{userName}, #{prodNo}, 0) <!-- 찜 목록은 기본 수량을 0로 설정 -->
    </insert>

    <!-- 장바구니 목록 조회 -->
    <select id="getCartList" parameterType="String" resultMap="purchaseSelectMap">
        SELECT wc.wishcart_no, wc.username, wc.prod_no, wc.cnt_prod, p.prod_name, p.prod_price,
               p.prod_img1, p.prod_status, pt.tran_point
        FROM WishCart wc
                 JOIN Product p ON wc.prod_no = p.prod_no
                 LEFT JOIN Point_Transaction pt ON pt.prod_no = p.prod_no
        WHERE wc.username = #{userName}
    </select>

    <!-- 찜 목록 조회 -->
    <select id="getWishList" parameterType="String" resultMap="purchaseSelectMap">
        SELECT wc.wishcart_no, wc.username, wc.prod_no, p.prod_name, p.prod_price,
               p.prod_img1, p.prod_status
        FROM WishCart wc
                 JOIN Product p ON wc.prod_no = p.prod_no
        WHERE wc.username = #{userName}
    </select>

    <!-- 장바구니 항목 삭제 -->
    <delete id="removeCart" parameterType="int">
        DELETE FROM WishCart WHERE wishcart_no = #{wishcartNo}
    </delete>

    <!-- 찜 목록 항목 삭제 -->
    <delete id="removeWish" parameterType="int">
        DELETE FROM WishCart WHERE wishcart_no = #{wishcartNo}
    </delete>

</mapper>