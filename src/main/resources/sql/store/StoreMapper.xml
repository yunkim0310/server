<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.placeHere.server.dao.StoreDao">

    <!--    <resultMap type="com.placeHere.server.domain.StoreOperation" id="StoreOperationResultMap">-->

    <!--    </resultMap>-->

    <resultMap id="StoreNewsResultMap" type="com.placeHere.server.domain.StoreNews">
        <id property="newsId" column="news_id" javaType="int" jdbcType="INTEGER"/>
        <result property="storeId" column="store_id" javaType="int" jdbcType="INTEGER"/>
        <result property="newsImg" column="news_img" javaType="String" jdbcType="VARCHAR"/>
        <result property="newsContents" column="news_contents" javaType="String" jdbcType="VARCHAR"/>
        <result property="regDt" column="reg_dt" javaType="java.time.LocalDateTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!--    <resultMap type="com.placeHere.server.domain.Store" id="StoreResultMap">-->

    <!--    </resultMap>-->

    <!-- 사업자 번호 중복 확인 -->
    <select id="chkDuplicateBusinessNo" parameterType="String" resultType="int">

        SELECT COUNT(business_no)
        FROM store
        WHERE store_status = 0
          AND business_no = #{businessNo}

    </select>

    <!-- 가게 등록 TEST-->
    <insert id="addStore" parameterType="com.placeHere.server.domain.Store" useGeneratedKeys="true" keyColumn="store_id" keyProperty="storeId">

        INSERT INTO store(username, business_no, store_name, store_addr, store_phone,
        store_info, food_category_id, special_menu_no,
        store_img1, store_img2, store_img3,
        store_img4, store_img5, hashtag)
        VALUES (#{userName}, #{businessNo}, #{storeName}, #{storeAddr}, #{storePhone:null},
        #{storeInfo:null}, #{foodCategoryId}, #{specialMenuNo},
        #{storeImgList[0]}, #{storeImgList[1]}, #{storeImgList[2]},
        #{storeImgList[3]}, #{storeImgList[4]},
        <if test="hashtagList != null and hashtagList.size() > 0">
            <foreach collection="hashtagList" open='"' close='"' separator="," item="hashtag">
                #{hashtag}
            </foreach>
        </if>
        <if test="hashtagList == null or hashtagList.size() == 0">
            NULL
        </if>

        )

    </insert>

    <!-- 가게 정보 조회 -->
    <!--    <select id="getStore"-->
    <!--            parameterType="com.placeHere.server.domain.Store"-->
    <!--            resultMap="StoreResultMap">-->

    <!--    </select>-->

    <!-- 가게 검색, 가게 목록 조회 -->
    <!--    <select id="getStoreList"-->
    <!--            parameterType="com.placeHere.server.domain.Search"-->
    <!--            resultMap="StoreResultMap">-->


    <!--    </select>-->

    <!-- 가게 수정 TEST-->
    <update id="updateStore" parameterType="com.placeHere.server.domain.Store">

        UPDATE store
        SET (store_name=#{storeName}, store_phone=#{storePhone:null}, store_info=#{storeInfo:null},
        food_category_id=#{foodCategoryId}, special_menu_no=#{specialMenuNo},
        store_img1=#{storeImgList[0]}, store_img2=#{storeImgList[1]}, store_img3=#{storeImgList[2]},
        store_img4=#{storeImgList[3]}, store_img5=#{storeImgList[4]},
        hashtag=
        <if test="hashtagList != null and hashtagList.size() > 0">
            <foreach collection="hashtagList" open='"' close='"' separator="," item="hashtag">
                #{hashtag}
            </foreach>
        </if>
        <if test="hashtagList == null or hashtagList.size() == 0">
            NULL
        </if>
        )
        WHERE store_id = #{storeId}

    </update>

    <!-- 가게 삭제 TEST-->
    <update id="removeStore" parameterType="int">

        UPDATE store
        SET store_status = 1
        WHERE store_id = #{storeId}

    </update>

    <!-- 편의시설 등록 TEST-->
    <insert id="addAmenities" parameterType="map">

        INSERT INTO amenities(store_id, amenities_no)
        VALUES
        <foreach collection="amenitiesNoList" item="amenitiesNo" separator=",">
            (#{storeId}, #{amenitiesNo})
        </foreach>

    </insert>

    <!-- 편의시설 삭제 (통채로 삭제후 다시 등록) TEST-->
    <delete id="removeAmenities" parameterType="int">

        DELETE FROM amenities
        WHERE store_id = #{storeId}

    </delete>

    <!-- 메뉴 등록 TEST-->
    <insert id="addMenu" parameterType="map">

        INSERT INTO Menu(store_id, menu_no, menu_img, menu_name, menu_price, menu_info)
        VALUES
        <foreach collection="menuList" item="menu" separator=",">
            (#{storeId}, #{menu.menuNo},#{menu.menuImg:null}, #{menu.menuName}, #{menu.menuPrice}, #{menu.menuInfo})
        </foreach>

    </insert>

    <!-- 메뉴 삭제 (통채로 삭제후 다시 등록) TEST-->
    <delete id="removeMenu" parameterType="int">

        DELETE FROM menu
        WHERE store_id = #{storeId}

    </delete>

    <!-- 가게 운영 등록 TODO-->
    <insert id="addOperation" parameterType="com.placeHere.server.domain.StoreOperation">

        INSERT INTO operation
        (store_id, open_time, close_time, break_time_start, break_time_end,
         security, rsrv_limit,
         regular_closeday1, regular_closeday2, regular_closeday3, effect_dt)
        VALUES
            (#{storeId}, #{openTime}, #{closeTime}, #{breakTimeStart}, #{breakTimeEnd},
             #{security}, #{rsrvLimit},
             #{regularClosedayList[0]}, #{regularClosedayList[1]}, #{regularClosedayList[2]},
             #{effectDt})

    </insert>

    <!-- 가게 운영 조회 (날짜로 적용되고 있는 운영 정보 조회) -->
    <!--    <select id="getOperationByDt"-->
    <!--            resultMap="StoreOperationResultMap">-->

    <!--    </select>-->

    <!-- 최신 가게 운영 조회 -->
    <!--    <select id="getCurrOperation"-->
    <!--            parameterType="int"-->
    <!--            resultMap="StoreOperationResultMap">-->

    <!--    </select>-->

    <!-- 매장 소식 등록 TODO-->
    <insert id="addStoreNews" parameterType="com.placeHere.server.domain.StoreNews">

        INSERT INTO store_news
            (store_id, news_img, news_contents, reg_dt)
        VALUES
            (#{storeId}, #{newsImg}, #{newsContents}, NOW())

    </insert>

    <!-- 매장 소식 목록 조회 TODO-->
    <select id="getStoreNewsList" parameterType="int" resultMap="StoreNewsResultMap">

        SELECT *
        FROM store_news
        WHERE store_id = #{storeId}

    </select>

    <!-- 매장 소식 수정 TODO-->
    <update id="updateStoreNews" parameterType="com.placeHere.server.domain.StoreNews">

        UPDATE store_news
        SET news_img=#{newsImg}, news_contents=#{newsContents}
        WHERE news_id = #{newsId}

    </update>

    <!-- 매장 소식 삭제 TODO-->
    <delete id="removeStoreNews" parameterType="int">

        DELETE FROM store_news
        WHERE news_id = #{newsId}

    </delete>

    <!-- 휴무일 등록 TODO-->
    <insert id="addCloseday" parameterType="map">

        INSERT INTO closeday(store_id, closeday)
        VALUES (#{storeId}, #{closeday})

    </insert>

    <!-- 휴무일 목록 조회 TODO-->
    <select id="getClosedayList" parameterType="map">

        SELECT closeday
        FROM closeday
        WHERE store_id = #{storeId}
          AND closeday BETWEEN #{search.startDate} AND #{search.endDate}
        ORDER BY closeday

    </select>

    <!-- 휴무일 삭제 TODO-->
    <delete id="removeCloseday" parameterType="int">

        DELETE FROM closeday
        WHERE closeday_id = #{closedayId}

    </delete>

</mapper>